<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Admin Bereich</title>
<link rel="stylesheet" href="/static/admin.css">
</head>
<body>

<div class="admin-container">

<h1>Adminbereich</h1>

<!-- Suchleiste + Export Button -->
<form method="get" class="search-box">
    <input type="hidden" name="pw" value="MEINADMINPASSWORT">
    <input type="text" id="search" name="q" placeholder="Suchen nach ID, Vorname, Nachname">
    <button type="submit">ğŸ” Suchen</button>
    <button type="get" formaction="/export" class="export-btn">Export Excel</button>
</form>

<table>
<tr>
    <th>ID</th>
    <th>Vorname</th>
    <th>Nachname</th>
    <th>Geburtsdatum</th>
    <th>Alter</th>
    <th>Geschlecht</th>
    <th>Gruppe</th>
    <th>Verse</th>
    <th>Anwesenheit</th>
    <th>Punkte</th>
    <th>Unterschrift</th>
    <th>Aktion</th>
</tr>

{% for c in registrations %}
<tr>
<form method="POST" action="/update/{{ c.ID }}">
    <td>{{ c.ID }}</td>
    <td><input type="text" name="Vorname" value="{{ c.Vorname }}"></td>
    <td><input type="text" name="Nachname" value="{{ c.Nachname }}"></td>
    <td><input type="date" name="Geburtsdatum" value="{{ c.Geburtsdatum }}" onchange="updateAgeAndGroup(this, '{{ c.ID }}')"></td>
    <td><span id="age-{{ c.ID }}">{{ c.Alter }}</span></td>
    <td>
        <select name="Geschlecht">
            <option value=""></option>
            <option value="m" {% if c.Geschlecht=="m" %}selected{% endif %}>M</option>
            <option value="w" {% if c.Geschlecht=="w" %}selected{% endif %}>W</option>
        </select>
    </td>
    <td><input type="text" name="Gruppe" id="group-{{ c.ID }}" value="{{ c.Gruppe }}" readonly></td>
    
    <!-- 5 Verse Checkboxen -->
    <td>
    {% for i in range(1,6) %}
        <input type="checkbox" name="Verse{{i}}" {% if c.Verse[i-1] %}checked{% endif %}>
    {% endfor %}
    </td>

    <!-- 5 Tage Checkboxen -->
    <td>
    {% for i in range(1,6) %}
        <input type="checkbox" name="Tag{{i}}" {% if c.Anwesenheit[i-1] %}checked{% endif %}>
    {% endfor %}
    </td>

    <td><span id="punkte-{{ c.ID }}">{{ c.Punkte }}</span></td>

    <td>
        {% if c.Unterschrift %}
            <img src="{{ c.Unterschrift }}" height="40">
        {% endif %}
    </td>

    <td class="actions">
        <button type="submit" class="save-btn">ğŸ’¾</button>
        <a class="delete" href="/delete/{{ c.ID }}?pw=MEINADMINPASSWORT">ğŸ—‘</a>
    </td>
</form>
</tr>
{% endfor %}

</table>
</div>

<script>
// Alter & Gruppe automatisch berechnen
function updateAgeAndGroup(input, id) {
    const birthDate = new Date(input.value);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
    document.getElementById('age-' + id).innerText = age;

    let group = '';
    if (age >= 5 && age <= 7) group = '5-7';
    else if (age >= 8 && age <= 13) group = '8-13';
    document.getElementById('group-' + id).value = group;

    updatePoints(id);
}

// Punkte = Summe Tage + Verse
function updatePoints(id) {
    const row = document.getElementById('age-' + id).closest('tr');
    const checkboxes = row.querySelectorAll('input[type="checkbox"]');
    let points = 0;
    checkboxes.forEach(cb => { if(cb.checked) points++; });
    document.getElementById('punkte-' + id).innerText = points;
}

// Punkte live bei Checkbox-Klick
document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
        const row = this.closest('tr');
        const id = row.querySelector('span[id^="age-"]').id.split('-')[1];
        updatePoints(id);
    });
});
</script>

</body>
</html>
